<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.kafka_chat.chat.chat.ChatPrivateMapper">

    <!-- ðŸ”” ===== ê¸°ë³¸ ì±„íŒ… ë©”ì„œë“œë“¤ ===== ðŸ”” -->

    <!-- ì±„íŒ… ë©”ì‹œì§€ ì €ìž¥ -->
    <insert id="insertPrivateMessage" parameterType="com.example.kafka_chat.chat.chat.ChatMessage">
        INSERT INTO chat_private_message (room_id, sender, message, timestamp)
        VALUES (#{roomId}, #{sender}, #{message}, #{timestamp})
    </insert>

    <!-- ì±„íŒ… ë©”ì‹œì§€ ížˆìŠ¤í† ë¦¬ ì¡°íšŒ -->
    <select id="getPrivateMessagesByRoomId" parameterType="string" resultType="com.example.kafka_chat.chat.chat.ChatMessage">
        SELECT id, room_id AS roomId, sender, message, timestamp
        FROM chat_private_message
        WHERE room_id = #{roomId}
        ORDER BY timestamp ASC
    </select>

    <!-- ë°© ì‚­ì œ -->
    <delete id="deletePrivateRoomById">
        DELETE FROM chat_private_room WHERE id = #{roomId}
    </delete>

    <!-- ðŸ”¥ ===== ì½ìŒ ìƒíƒœ ê´€ë¦¬ ì¿¼ë¦¬ë“¤ (DB ê¸°ë°˜) ===== ðŸ”¥ -->

    <!-- ì±„íŒ…ë°© ì •ë³´ ì¡°íšŒ -->
    <select id="findPrivateRoomById" parameterType="long" resultType="com.example.kafka_chat.chat.chat.ChatPrivateRoom">
        SELECT id, name, password,
        create_id as createId,
        invite_id as inviteId,
        create_user_last_read as createUserLastRead,
        invite_user_last_read as inviteUserLastRead,
        created_at as createdAt
        FROM chat_private_room
        WHERE id = #{roomId}
    </select>

    <!-- ì•ˆì½ì€ ë©”ì‹œì§€ ê°œìˆ˜ ì¡°íšŒ (LocalDateTime ì‚¬ìš©) -->
    <select id="countUnreadPrivateMessages" resultType="int">
        SELECT COUNT(*)
        FROM chat_private_message
        WHERE room_id = #{roomId}
        AND timestamp > #{lastReadTime}
    </select>

    <!-- ìƒì„±ìž ì½ìŒ ì‹œê°„ ì—…ë°ì´íŠ¸ (LocalDateTime ì‚¬ìš©) -->
    <update id="updateCreateUserLastRead">
        UPDATE chat_private_room
        SET create_user_last_read = #{readTime}
        WHERE id = #{roomId}
    </update>

    <!-- ì´ˆëŒ€ìž ì½ìŒ ì‹œê°„ ì—…ë°ì´íŠ¸ (LocalDateTime ì‚¬ìš©) -->
    <update id="updateInviteUserLastRead">
        UPDATE chat_private_room
        SET invite_user_last_read = #{readTime}
        WHERE id = #{roomId}
    </update>

    <!-- ðŸ”” ===== ìœ í‹¸ë¦¬í‹° ì¿¼ë¦¬ë“¤ ===== ðŸ”” -->

    <!-- ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì¡°íšŒ -->
    <select id="getLastPrivateMessage" resultType="com.example.kafka_chat.chat.chat.ChatMessage">
        SELECT id, room_id AS roomId, sender, message, timestamp
        FROM chat_private_message
        WHERE room_id = #{roomId}
        ORDER BY timestamp DESC
        LIMIT 1
    </select>

    <!-- ì²« ë²ˆì§¸ ë©”ì‹œì§€ ì¡°íšŒ -->
    <select id="getFirstPrivateMessage" resultType="com.example.kafka_chat.chat.chat.ChatMessage">
        SELECT id, room_id AS roomId, sender, message, timestamp
        FROM chat_private_message
        WHERE room_id = #{roomId}
        ORDER BY timestamp ASC
        LIMIT 1
    </select>

    <!-- ì´ ë©”ì‹œì§€ ê°œìˆ˜ ì¡°íšŒ -->
    <select id="countTotalPrivateMessages" resultType="int">
        SELECT COUNT(*)
        FROM chat_private_message
        WHERE room_id = #{roomId}
    </select>

    <!-- íŠ¹ì • ì‚¬ìš©ìžì˜ ë©”ì‹œì§€ ê°œìˆ˜ ì¡°íšŒ -->
    <select id="countPrivateMessagesByUser" resultType="int">
        SELECT COUNT(*)
        FROM chat_private_message
        WHERE room_id = #{roomId}
        AND sender = #{userId}
    </select>

    <!-- íŠ¹ì • ì‹œê°„ ì´í›„ ë©”ì‹œì§€ ì¡°íšŒ -->
    <select id="getPrivateMessagesAfterTime" resultType="com.example.kafka_chat.chat.chat.ChatMessage">
        SELECT id, room_id AS roomId, sender, message, timestamp
        FROM chat_private_message
        WHERE room_id = #{roomId}
        AND timestamp > #{timestamp}
        ORDER BY timestamp ASC
    </select>

    <!-- íŠ¹ì • ì‚¬ìš©ìžë¥¼ ì œì™¸í•œ ì•ˆì½ì€ ë©”ì‹œì§€ ê°œìˆ˜ (String ê¸°ë°˜) -->
    <select id="countUnreadPrivateMessagesExcludingUser" resultType="int">
        SELECT COUNT(*)
        FROM chat_private_message
        WHERE room_id = #{roomId}
        AND timestamp > #{lastReadTime}
        AND sender != #{userId}
    </select>

    <!-- íŠ¹ì • ì‚¬ìš©ìžê°€ ë³´ë‚¸ ë©”ì‹œì§€ ì¤‘ íŠ¹ì • ì‹œê°„ ì´í›„ì˜ ê°œìˆ˜ (String ê¸°ë°˜) -->
    <select id="countUnreadPrivateMessagesFromUser" resultType="int">
        SELECT COUNT(*)
        FROM chat_private_message
        WHERE room_id = #{roomId}
        AND sender = #{sender}
        AND timestamp > #{timestamp}
    </select>

    <!-- ðŸ”¥ ===== ë°°ì¹˜ ì²˜ë¦¬ìš© ì¿¼ë¦¬ë“¤ ===== ðŸ”¥ -->

    <!-- ì—¬ëŸ¬ ë°© ì •ë³´ í•œë²ˆì— ì¡°íšŒ -->
    <select id="findPrivateRoomsByIds" resultType="com.example.kafka_chat.chat.chat.ChatPrivateRoom">
        SELECT id, name, password,
        create_id as createId,
        invite_id as inviteId,
        create_user_last_read as createUserLastRead,
        invite_user_last_read as inviteUserLastRead,
        created_at as createdAt
        FROM chat_private_room
        WHERE id IN
        <foreach collection="roomIds" item="roomId" open="(" close=")" separator=",">
            #{roomId}
        </foreach>
    </select>

    <!-- ì‚¬ìš©ìžê°€ ì°¸ì—¬í•œ ëª¨ë“  ë°© ì¡°íšŒ -->
    <select id="findPrivateRoomsByUserId" resultType="com.example.kafka_chat.chat.chat.ChatPrivateRoom">
        SELECT id, name, password,
        create_id as createId,
        invite_id as inviteId,
        create_user_last_read as createUserLastRead,
        invite_user_last_read as inviteUserLastRead,
        created_at as createdAt
        FROM chat_private_room
        WHERE create_id = #{userId} OR invite_id = #{userId}
    </select>

    <!-- ë°© ìƒì„± -->
    <insert id="insertPrivateRoom" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO chat_private_room (name, password, create_id, invite_id, create_user_last_read, invite_user_last_read, created_at)
        VALUES (#{name}, #{password}, #{createId}, #{inviteId}, NOW(), NOW(), NOW())
    </insert>

</mapper>